# Документация для Backend сервиса

  

## Обзор

  

Backend представляет собой FastAPI приложение для распознавания инструментов на изображениях

  
  

## Краткая памятка

  

Для локального запуска бекенд-сервиса требуется создать файл .env и запустить докер контейнер. Сервис автоматизированный, при старте база данных обновится до актуальной миграции, и при отсутсвии дефолтных данных, выполнится скрипт заполнения(utils/mock.py) таблиц информацией о наборе из 11 инструментов. Для более подробной информации ознакомтесь с документацией полноценно. В ней содержится описание структуры и параметров для корректной работы сервиса

  
  
  

## Архитектура

  

### Технологический стек

-  **FastAPI** - веб-фреймворк для создания API

-  **PostgreSQL** - основная база данных

-  **Redis** - кэширование и сессии

-  **SQLAlchemy** - ORM для работы с БД

-  **Docker** - контейнеризация

  

### Структура проекта

```

backend/

├── src/

│ ├── api/ # API эндпоинты

│ ├── models/ # Модели базы данных

| |–– media/ # Слой для сохранения изображений

│ ├── schemas/ # Pydantic схемы

│ ├── services/ # Сервисный слой

│ ├── repo/ # Слой репозитория для работы с БД

│ ├── ML/ # Модель машинного обучения

│ ├── utils/ # Утилиты

│ └── migrations/ # Миграции БД

├── docker-compose.yml

|–– Makefile # Удобное взаимодействие с докером

├── Dockerfile

└── requirements.txt

```

  

## Модели данных

  

### Основные сущности

  

#### User (Пользователь)

-  `id` - уникальный идентификатор

-  `name` - имя пользователя

-  `employee_number` - номер сотрудника

-  `role` - роль в системе (enum)

  

#### Tool (Инструмент)

-  `id` - уникальный идентификатор

-  `name` - название инструмента

-  `serial_number` - серийный номер

-  `category` - категория инструмента

  

#### ToolKit (Набор инструментов)

-  `id` - уникальный идентификатор

-  `name` - название набора

-  `description` - описание набора

  

#### ToolKitItem (Элемент набора)

-  `tool_id` - ссылка на инструмент

-  `toolkit_id` - ссылка на набор

-  `quantity` - количество инструментов

  

#### Transaction (Транзакция)

-  `id` - уникальный идентификатор

-  `user_id` - пользователь

-  `toolkit_id` - набор инструментов

-  `type` - тип транзакции (enum)

-  `transaction_time` - время транзакции

-  `status` - статус (enum)

  

## API Endpoints

  

### Базовые эндпоинты

  

#### GET `/base/health`

Проверка состояния сервиса и подключений к БД.

  

### Эндпоинты для анализа изображений

  

#### POST `/predict/`

Анализ одного изображения на наличие инструментов.

  

**Параметры:**

-  `image` (file) - изображение для анализа

-  `toolkit_id` (int) - ID набора инструментов

-  `confidence` (float, optional) - порог уверенности (по умолчанию 0.5)

  
  
  

#### POST `/predict/batch`

Анализ нескольких изображений.

  

**Параметры:**

-  `images` (files) - массив изображений

-  `toolkit_id` (int) - ID набора инструментов

-  `confidence` (float, optional) - порог уверенности

  
  
  

#### POST `/predict/zip`

Анализ изображений из ZIP-архива.

  

**Параметры:**

-  `zip_file` (file) - ZIP-архив с изображениями

-  `toolkit_id` (int) - ID набора инструментов

-  `confidence` (float, optional) - порог уверенности

  

### Медиа эндпоинты

  

#### GET `/media/{filename}`

Получение обработанных изображений.

  
  
### Дополнительные CRUD-эндпоинты

Этот набор эндпоинтов предоставляет базовые операции управления данными системы (создание, чтение, обновление, удаление) для интеграции внешних систем с нашим решением. Они не обязательны для работы и включены как расширение для автоматизации и синхронизации справочников/составов.

### Пользовательские эндпоинты

#### GET `/users`

Получение списка пользователей с пагинацией.

**Параметры:**

-   `limit` (int, optional) - размер страницы (по умолчанию 20, максимум 100)
    
-   `offset` (int, optional) - смещение (по умолчанию 0)





#### GET `/users/{user_id}`

Получение одного пользователя по ID.

**Параметры:**

-   `user_id` (int) - ID пользователя
 




#### POST `/users/`

Создание пользователя.

**Параметры:**

*Тело запроса JSON:*
-   `name` (str, required) - имя пользователя
    
-   `employee_number` (str, required) - уникальный табельный номер
    
-   `role` (enum, optional) - роль пользователя





#### PUT `/users/{user_id}`

Частичное обновление пользователя.

**Параметры:**

- `user_id` (int) - ID пользователя

*Тело запроса JSON:*

-   `name` (str, optional) - имя пользователя
    
-   `employee_number` (str, optional) - уникальный табельный номер
    
-   `role` (enum, optional) - роль пользователя





#### DELETE `/users/{user_id}`

Удаление пользователя.

**Параметры:**

- `user_id` (int) - ID пользователя



### Эндпоинты для инструментов

#### GET `/tools`

Получение списка инструментов с пагинацией и фильтрами.

**Параметры:**

-   `limit` (int, optional) - размер страницы (по умолчанию 20, максимум 100)
    
-   `offset` (int, optional) - смещение (по умолчанию 0)
    
-   `category` (str, optional) - фильтр по категории
    
-   `q` (str, optional) - поиск по имени/серийному номеру



#### GET `/tools/{tool_id}`

Получение одного инструмента по ID.

**Параметры:**

-   `tool_id` (int) - ID инструмента



#### POST `/tools/`

Создание инструмента.

**Параметры:**

*Тело запроса JSON:*

-   `name` (str, required) - наименование
    
-   `serial_number` (str, required) - уникальный серийный номер
    
-   `category` (str, required) - категория инструмента



#### PUT `/tools/{tool_id}`

Частичное обновление инструмента.

**Параметры:**

- `tool_id` (int) - ID инструмента

*Тело запроса JSON:*
-   `name` (str, optional) - наименование

-   `serial_number` (str, optional) - серийный номер (при изменении должен оставаться уникальным; в некоторых инсталляциях изменение может быть запрещено бизнес-правилами)
    
-   `category` (str, optional) - категория инструмента



#### DELETE `/tools/{tool_id}`

Удаление инструмента.

**Параметры:**

- `tool_id` (int) - ID инструмента

*Примечание:* удаление может быть отклонено, если инструмент используется в составах наборов.



### Эндпоинты для наборов инструментов

#### GET `/toolkits`

Получение списка наборов с пагинацией и поиском по названию.

**Параметры:**

-   `limit` (int, optional) - размер страницы (по умолчанию 20, максимум 100)
    
-   `offset` (int, optional) - смещение (по умолчанию 0)
    
-   `q` (str, optional) - поиск по имени набора



#### GET `/toolkits/{toolkit_id}`

Получение одного набора по ID (с полным составом `items`).

**Параметры:**

- `toolkit_id` (int) - ID набора



#### PUT `/toolkits/{toolkit_id}`

Частичное обновление набора.

**Параметры:**

- `toolkit_id` (int) - ID набора

*Тело запроса JSON:*

-   `name` (str, optional) - новое название
    
-   `description` (str, optional) - новое описание



#### DELETE `/toolkits/{toolkit_id}`

Удаление набора.

**Параметры:**

- `toolkit_id` (int) - ID набора



### Эндпоинты для позиций набора (ToolKit Items):

#### GET `/toolkits/{toolkit_id}/items`

Получение списка позиций набора.

**Параметры:**

- `toolkit_id` (int) - ID набора



#### GET `/toolkits/{toolkit_id}/items/{item_id}`

Получение одной позиции набора по ID.

**Параметры:**

-   `toolkit_id` (int) - ID набора
    
-   `item_id` (int) - ID позиции



#### POST `/toolkits/{toolkit_id}/items`

Добавление новой позиции в набор или замена количества, если такая позиция уже существует.

**Параметры:**

*Тело запроса JSON:*

-   `tool_id` (int, required) - ID инструмента
    
-   `quantity` (int, required) - количество инструментов (больше 0)



#### PUT `/toolkits/{toolkit_id}/items/{item_id}`

Частичное обновление позиции набора.

**Параметры:**

-   `toolkit_id` (int) - ID набора
    
-   `item_id` (int) - ID позиции

*Тело запроса JSON:*

`quantity` (int, optional) - количество инструментов (больше 0)



#### DELETE `/toolkits/{toolkit_id}/items/{item_id}`

Удаление позиции из набора.

**Параметры:**

- `toolkit_id` (int) - ID набора



## Flow работы

```

–– Frontend делает запрос на один из эндпоинтов для анализа изображения

–– Backend принимает изображение вместе с данными о наборе

–– Backend запускает ML скрипт с полученной информацией

–– ML прогоняет через себя данные с Backend, на выходе отправляет найденные инструменты и обработанное изображение с маркировками

–– Backend формирует ответ для Frontend и url для получения изображения

```

  

## Конфигурация

  

### Переменные окружения

Создайте файл `.env` в корне backend директории:

Пример присутсвует в файле env_backend.md

  

```env

# Redis Configuration

REDIS_PASSWORD=your_redis_password

REDIS_HOST=redis

REDIS_PORT=6379

REDIS_DB=0

  

# Database Configuration

DB_NAME=your_db_name

DB_USER=your_db_user

DB_PASSWORD=your_db_password

DB_HOST=db

DB_PORT=5432

```

  

## Развертывание

  

### Через makefile

  

```bash

cd  backend

make  compose-up

```

  

### Docker Compose

```bash

cd  backend

docker-compose  up  -d

```

  

### Ручной запуск

```bash

cd  backend

pip  install  -r  requirements.txt

python  src/main.py

```

  

## Миграции базы данных

  

### Создание миграции

```bash

cd  backend

alembic  revision  --autogenerate  -m  "description"

```

  

### Применение миграций

```bash

cd  backend

alembic  upgrade  head

```

  

## Производительность

  

### Оптимизации

- Использование ассинхронных функций для работы с PostgreSQL и взаимодействия с ML

  
  

### Кэширование

- Redis для кэширования результатов

- Временные файлы автоматически удаляются

  

## Безопасность

  

### Валидация файлов

- Проверка типов файлов

- Ограничение доступа к медиа файлам

- Валидация путей файлов

  

### Обработка ошибок

- Graceful handling подключений к БД

- Автоматическая очистка временных файлов

- Детальные сообщения об ошибках

  

## Мониторинг

  

### Health Check

Эндпоинт `/base/health` предоставляет информацию о состоянии:

- Подключение к PostgreSQL

- Подключение к Redis

- Общий статус сервиса

  

### Логирование

- Время инференса ML модели

- Ошибки подключения к внешним сервисам

- Статистика обработки изображений

  

## Разработка

  

### Структура кода

-  **API Layer** - эндпоинты и валидация

-  **Service Layer** - бизнес-логика

-  **Repository Layer** - работа с БД

-  **ML Layer** - модель машинного обучения

  

### Тестирование

Для тестирования API и докумнетации по эндпоинтам используйте :

- Swagger UI: `http://localhost:8000/docs`

  

### Добавление новых инструментов

1. Обновите `CLASS_NAMES` в `src/ML/yolo.py`

2. Переобучите модель YOLO

3. Обновите пороги в `class_thresholds`

4. Добавьте инструменты в БД